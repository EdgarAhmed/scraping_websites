name: Daily Smartphones Scraping Job

on:
  schedule:
    - cron: '0 6 * * *'  # Run at 8 AM daily (different from ebooks at 7 AM)
  workflow_dispatch:  # Allow manual trigger

jobs:
  run-smartphones-scraping:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip gnupg
        
        # Install Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        google-chrome --version
        
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        
        # Main dependencies
        pip install selenium pandas webdriver-manager lxml
        
        # Google Drive API dependencies
        pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
        
        # If requirements.txt exists, install it too
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi
        
    - name: Run Python smartphones scraping script
      env:
        # Environment variables for Chrome
        DISPLAY: :99
        PYTHONUNBUFFERED: 1
        
        # Google Drive credentials (configure this in GitHub Secrets)
        GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      run: |
        echo "üìÅ Working directory: $(pwd)"
        echo "üìÅ Repository structure:"
        ls -la
        echo ""
        echo "üìÅ Looking for Python scripts:"
        find . -name "*.py" -type f | grep -i "smart" || echo "No smartphone scripts found by name pattern"
        
        echo "üöÄ Starting MediaMarkt SMARTPHONES scraping..."
        echo "üîÑ Configuring Google Drive..."
        
        # Check if Google Drive credentials are available
        if [ -z "$GOOGLE_CREDENTIALS_JSON" ]; then
          echo "‚ö†Ô∏è  WARNING: No Google Drive credentials configured"
          echo "‚ÑπÔ∏è   The script will run but won't update Google Drive"
        else:
          echo "‚úÖ Google Drive credentials configured"
        
        # Create directory for results
        mkdir -p scraping_results
        
        # First, look for the new script name we created
        if [ -f "02_scrip_smartphones.py" ]; then
          echo "‚úÖ Found script at: 02_scrip_smartphones.py"
          SCRIPT_PATH="02_scrip_smartphones.py"
        elif [ -f "scrips_py/02_scrip_smartphones.py" ]; then
          echo "‚úÖ Found script at: scrips_py/02_scrip_smartphones.py"
          SCRIPT_PATH="scrips_py/02_scrip_smartphones.py"
        else
          echo "üîç Looking for any Python files containing 'smartphone'..."
          find . -name "*.py" -type f -exec grep -l "smartphone" {} \; 2>/dev/null || echo "No smartphone-related scripts found"
          echo ""
          echo "üîç Creating minimal script from notebook content..."
          # Create a backup script from the provided code
          cat > temp_smartphones_script.py << 'EOF'
#!/usr/bin/env python3
"""
Script de scraping para smartphones de MediaMarkt con actualizaci√≥n en Google Drive
EXACTLY matches the old notebook scraping logic
"""
print("This is a placeholder script. Please save the actual script as '02_scrip_smartphones.py'")
EOF
          SCRIPT_PATH="temp_smartphones_script.py"
        fi
        
        # Execute the script
        echo "üöÄ Executing script: $SCRIPT_PATH"
        python $SCRIPT_PATH
        
        echo "‚úÖ Script executed. Checking results..."
        
        # List generated files
        echo "üìÑ Generated files in scraping_results/:"
        ls -la scraping_results/ 2>/dev/null || echo "No results in scraping_results/"
        echo ""
        echo "üìÑ All CSV files in repository:"
        find . -name "*.csv" -type f 2>/dev/null | head -20 || echo "No CSV files found"
        
    - name: Upload results as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: smartphones-scraping-output
        path: |
          scraping_results/*.csv
          *.csv
        retention-days: 7
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå MediaMarkt SMARTPHONES scraping has failed"
        echo "Check the logs for more details"
        echo ""
        echo "Possible issues:"
        echo "1. Script not found or not properly saved"
        echo "2. Website structure changed for smartphones category"
        echo "3. Google Drive folder permissions for smartphones folder"
        echo "4. Chrome version incompatibility"
        echo ""
        echo "IMPORTANT: Save the Python script as '02_scrip_smartphones.py' in the root or scrips_py/ directory"
